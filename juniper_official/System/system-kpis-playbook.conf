iceberg {
    topic system_cpu {
        description "This topic is to monitor's system cpu and sends an alert in case utilization is above thresholds";
        rule system_cpu {
            keys route_engine;
            function subtract {
                description "function that tweaks thresholds by subtracting them from 100 so that cpu utilization can be found from cpu-idle%";
                path system_sensors.py;
                method subtract;
                argument threshold {
                    mandatory;
                }
            }
            sensor components {
                open-config {
                    sensor-name /components/;
                    frequency 20s;
                }
            }
            field re_cpu_utilization {
                sensor components {
                    where "/components/component/properties/property/@name == 'cpu-utilization-idle'";
                    path /components/component/properties/property/state/value;
                }
                description "This field is for re cpu idle utilization";
            }
            field re_cpu_utilization_higher_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_Higher_Threshold}}";
                    }
                }
                type integer;
                description "This field is for re cpu utilization higher threshold value";
            }
            field re_cpu_utilization_lower_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_Lower_Threshold}}";
                    }
                }
                type integer;
                description "This field is for re cpu utilization lower threshold value";
            }
            field route_engine {
                sensor components {
                    where "/components/component/@name =~ /^Routing Engine[{{RE_Slot_No}}]*$/";
                    path "/components/component/@name";
                }
                description "This field is for re identification";
            }
            trigger re_cpu_utilization {
                term is_re_cpu_utilization_normal {
                    when {
                        greater-than-or-equal-to "$re_cpu_utilization" "$re_cpu_utilization_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "$route_engine cpu utilization is lesser than lower threshold";
                        }
                    }
                }
                term is_re_cpu_utilization_median {
                    when {
                        greater-than-or-equal-to "$re_cpu_utilization" "$re_cpu_utilization_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message " $route_engine cpu utilization is in medium range";
                        }
                    }
                }
                term is_re_cpu_utilization_abnormal {
                    then {
                        status {
                            color red;
                            message "$route_engine cpu utilization is greater than higher threshold";
                        }
                    }
                }
            }
            variable RE_CPU_Utilization_Higher_Threshold {
                value 50;
                description "Enter re cpu utilization maximum threshold values if default value not matches with your requirement";
                type int;
            }
            variable RE_CPU_Utilization_Lower_Threshold {
                value 20;
                description "Enter re cpu utilization maximum threshold values if default value not matches with your requirement";
                type int;
            }
            variable RE_Slot_No {
                value 0-1;
                description "Enter RE numbers to be monitored i.e. 0 or 1, deafult is set for both res ";
                type string;
            }
        }
        rule system_cpu_load_average {
            keys slot;
            function subtract {
                description "function that tweaks thresholds by subtracting them from 100 so that cpu utilization can be found from cpu-idle%";
                path system_sensors.py;
                method subtract;
                argument threshold {
                    mandatory;
                }
            }
            sensor CPUutilizationTable {
                iAgent {
                    file SystemCpu.yml;
                    table CPUutilizationTable;
                    frequency 10s;
                }
            }
            field cpu_utilization_15min_higher_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_15min_Higher_Threshold}}";
                    }
                }
                type integer;
                description "This field shows processes to be monitored";
            }
            field cpu_utilization_15min_lower_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_15min_Lower_Threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_1min_higher_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_1min_Higher_Threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_1min_lower_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_1min_Lower_Threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_5min_higher_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_5min_Higher_Threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_5min_lower_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument threshold "{{RE_CPU_Utilization_5min_Lower_Threshold}}";
                    }
                }
                type integer;
            }
            trigger cpu-utilization-15min {
                term green {
                    when {
                        greater-than-or-equal-to "$cpu-idle-15min" "$cpu_utilization_15min_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "Routing Engine$slot 15min cpu utilization is lesser than lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        greater-than-or-equal-to "$cpu-idle-15min" "$cpu_utilization_15min_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "Routing Engine$slot 15min cpu utilization is in medium range";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "Routing Engine$slot  15min cpu utilization is greater than higher threshold";
                        }
                    }
                }
            }
            trigger cpu-utilization-1min {
                term green {
                    when {
                        greater-than-or-equal-to "$cpu-idle-1min" "$cpu_utilization_1min_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "Routing Engine$slot 1min cpu utilization is lesser than lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        greater-than-or-equal-to "$cpu-idle-1min" "$cpu_utilization_1min_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "Routing Engine$slot  1min cpu utilization is in medium range";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "Routing Engine$slot 1min cpu utilization is greater than higher threshold";
                        }
                    }
                }
            }
            trigger cpu-utilization-5min {
                term green {
                    when {
                        greater-than "$cpu-idle-5min" "$cpu_utilization_5min_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "Routing Engine$slot 5min cpu utilization is lesser than lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        greater-than "$cpu-idle-5min" "$cpu_utilization_5min_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "Routing Engine$slot 5min cpu utilization is in medium range";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "Routing Engine$slot 5min cpu utilization is greater than higher threshold";
                        }
                    }
                }
            }
            variable RE_CPU_Utilization_15min_Higher_Threshold {
                value 75;
                type int;
            }
            variable RE_CPU_Utilization_15min_Lower_Threshold {
                value 25;
                type int;
            }
            variable RE_CPU_Utilization_1min_Higher_Threshold {
                value 80;
                type int;
            }
            variable RE_CPU_Utilization_1min_Lower_Threshold {
                value 40;
                type int;
            }
            variable RE_CPU_Utilization_5min_Higher_Threshold {
                value 75;
                type int;
            }
            variable RE_CPU_Utilization_5min_Lower_Threshold {
                value 25;
                type int;
            }
        }
    }
    topic system_memory {
        description "This topic is to monitor's system memory and sends an alert in case utilization is above thresholds";
        rule system_memory {
            keys route_engine;
            sensor components {
                open-config {
                    sensor-name /components/;
                    frequency 20s;
                }
            }
            field re_memory_buffer {
                sensor components {
                    where "/components/component/properties/property/@name == 'memory-utilization-buffer'";
                    path /components/component/properties/property/state/value;
                }
                type integer;
            }
            field re_memory_buffer_higher_threshold {
                constant {
                    value "{{RE_Memory_Buffer_Higher_Threshold}}";
                }
                type integer;
            }
            field re_memory_buffer_lower_threshold {
                constant {
                    value "{{RE_Memory_Buffer_Lower_Threshold}}";
                }
                type integer;
            }
            field route_engine {
                sensor components {
                    where "/components/component/@name =~ /^Routing Engine[{{RE_Slot_No}}]*$/";
                    path "/components/component/@name";
                }
                type string;
            }
            trigger re_memory_buffer_utilization {
                term green {
                    when {
                        less-than-or-equal-to "$re_memory_buffer" "$re_memory_buffer_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "$route_engine memory buffer utilization($re_memory_buffer) is lesser than lower threshold($re_memory_buffer_lower_threshold)";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$re_memory_buffer" "$re_memory_buffer_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "$route_engine memory buffer utilization($re_memory_buffer) is in medium range(>=$re_memory_buffer_lower_threshold, <=$re_memory_buffer_higher_threshold)";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "$route_engine memory buffer utilization($re_memory_buffer) is greater than higher threshold($re_memory_buffer_higher_threshold)";
                        }
                    }
                }
            }
            variable RE_Memory_Buffer_Higher_Threshold {
                value 60;
                type int;
            }
            variable RE_Memory_Buffer_Lower_Threshold {
                value 20;
                type int;
            }
            variable RE_Slot_No {
                value 0-1;
                type string;
            }
        }
    }
    topic system_processes {
        description "This topic is to monitori the cpu, memory utilization of junos system processes";
        rule process_cpu {
            keys cmd;
            sensor SystemProcExtTable {
                iAgent {
                    file SystemProcExt.yml;
                    table SystemProcExtTable;
                    frequency 10s;
                }
            }
            field cmd {
                sensor SystemProcExtTable {
                    path cmd;
                }
                description "This field is to parse all junos processes names";
            }
            field max_threshold {
                constant {
                    value "{{max_threshold}}";
                }
                type integer;
                description "This field is for processes cpu maximum threshold value";
            }
            field min_threshold {
                constant {
                    value "{{min_threshold}}";
                }
                type integer;
                description "This field is for processes cpu minimum threshold value";
            }
            field process_name {
                constant {
                    value "{{process_name}}";
                }
                type string;
                description "This field shows processes to be monitored";
            }
            field wcpu {
                sensor SystemProcExtTable {
                    path wcpu;
                }
                description "This field shows cpu utilization for corresponding processes";
            }
            trigger check_processes_cpu {
                term skip_undefined_processes {
                    when {
                        does-not-match-with "$cmd" "$process_name";
                    }
                }
                term is_cpu_utilization_normal {
                    when {
                        less-than-or-equal-to "$wcpu" "$min_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "$cmd cpu utilization($wcpu) is below lower threshold($min_threshold)";
                        }
                    }
                }
                term is_cpu_utilization_median {
                    when {
                        less-than-or-equal-to "$wcpu" "$max_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "$cmd cpu utilization($wcpu) is in medium range(>=$min_threshold, <=$max_threshold)";
                        }
                    }
                }
                term is_cpu_utilization_abnormal {
                    then {
                        status {
                            color red;
                            message "$cmd cpu utilization($wcpu) is above higher threshold($max_threshold)";
                        }
                    }
                }
            }
            variable max_threshold {
                value 70;
                description "Enter processes cpu maximum threshold values if default value not matches with your requirement";
                type int;
            }
            variable min_threshold {
                value 20;
                description "Enter processes cpu minimum threshold values if default value not matches with your requirement";
                type int;
            }
            variable process_name {
                value "chassisd|pfed|cosd|snmpd|dcd|dfwd|eventd|mgd|mib2d|rpd";
                description "Enter processes to be monitored with separator or leave it to default";
                type string;
            }
        }
        rule process_memory {
            keys cmd;
            function isExceeding {
                path system_processes.py;
                method isExceeding;
                argument res {
                    mandatory;
                }
                argument size {
                    mandatory;
                }
                argument threshold {
                    mandatory;
                }
            }
            sensor SystemProcExtTable {
                iAgent {
                    file SystemProcExt.yml;
                    table SystemProcExtTable;
                    frequency 10s;
                }
            }
            field cmd {
                sensor SystemProcExtTable {
                    path cmd;
                }
                description "This field is to parse all junos processes names";
            }
            field max_threshold {
                constant {
                    value "{{max_threshold}}";
                }
                type integer;
                description "This field is for processes memory maximum threshold value";
            }
            field min_threshold {
                constant {
                    value "{{min_threshold}}";
                }
                type integer;
            }
            field process_name {
                constant {
                    value "{{process_name}}";
                }
                type string;
                description "This field shows processes to be monitored";
            }
            field reserved {
                sensor SystemProcExtTable {
                    path res;
                }
                description "This field is for reserved memory";
            }
            field size {
                sensor SystemProcExtTable {
                    path size;
                }
                description "This field is for processes memory size";
            }
            trigger skiping_undefined_processes {
                term skip {
                    when {
                        does-not-match-with "$cmd" "$process_name";
                    }
                }
                term is_memory_utilization_normal {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$min_threshold";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "$cmd  memory utilization is below lower threshold($min_threshold)";
                        }
                    }
                }
                term is_memory_utilization_median {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$max_threshold";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "$cmd memory utilization is in medium range(>=$min_threshold, <=$max_threshold)";
                        }
                    }
                }
                term is_memory_utilization_abnormal {
                    then {
                        status {
                            color red;
                            message "$cmd memory utilization is above higher threshold($max_threshold)";
                        }
                    }
                }
            }
            variable max_threshold {
                value 70;
                description "Enter processes memory maximum threshold values if default value not matches with your requirement";
                type int;
            }
            variable min_threshold {
                value 20;
                description "Enter processes memory minimum threshold values if default value not matches with your requirement";
                type int;
            }
            variable process_name {
                value "chassisd|pfed|cosd|snmpd|dcd|dfwd|eventd|mgd|mib2d|rpd";
                description "Enter processes to be monitored with separator or leave it to default";
                type string;
            }
        }
    }
    topic system_storage {
        rule storage_used {
            keys filesystem-name;
            sensor StorageTable {
                iAgent {
                    file SystemStorage.yml;
                    table StorageTable;
                    frequency 20s;
                }
            }
            field higher_threshold {
                constant {
                    value "{{Higher_Threshold}}";
                }
                type integer;
            }
            field lower_threshold {
                constant {
                    value "{{Lower_Threshold}}";
                }
                type integer;
            }
            trigger fs_utilization {
                term is_system_storage_abnormal {
                    when {
                        greater-than-or-equal-to "$used-percent" "$higher_threshold";
                    }
                    then {
                        status {
                            color red;
                            message "storage used for $filesystem-name is above $higher_threshold%";
                        }
                    }
                }
                term is_system_storage_normal {
                    when {
                        less-than "$used-percent" "$lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "storage used for $filesystem-name is normal $used-percent%";
                        }
                    }
                }
                term is_system_storage_midian {
                    then {
                        status {
                            color yellow;
                            message "storage used for $filesystem-name is in medium range(>=$lower_threshold, <=$higher_threshold)";
                        }
                    }
                }
            }
            variable Higher_Threshold {
                value 70;
                type int;
            }
            variable Lower_Threshold {
                value 50;
                type int;
            }
        }
    }
    playbook system-kpis-playbook {
        rules [ system_cpu/system_cpu system_cpu/system_cpu_load_average system_memory/system_memory system_processes/process_cpu system_processes/process_memory system_storage/storage_used ];
        description "This playbook takes min, max thresholds as input and monitors system cpu, memory, storage and junos processes cpu and memory utilization";
        synopsis "System key performance indicators";
    }
    device sample-router1 {
        host 10.1.1.1;
        open-config {
            port 32767;
        }
        authentication {
            password {
                username test;
                password test123;
            }
        }
    }
    device sample-router2 {
        host 10.1.2.1;
        open-config {
            port 32767;
        }
        authentication {
            password {
                username test;
                password test123;
            }
        }
    }
    device-group sample-group1 {
        description t1;
        devices [ sample-router1 sample-router2 ];
        playbooks system-kpis-playbook;
    }
}
